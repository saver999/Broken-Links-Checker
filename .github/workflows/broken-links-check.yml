name: Broken Links Checker
on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 1 * *'
env:
  ISSUE_TEMPLATE: ".github/workflows/ISSUE_TEMPLATE.md"

  contents: read
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Get links from README.md
        id: get-links
        run: |
          LINKS=$(sed -nE 's/\[.*\]\((http[s]?:\/\/[^)]*)\)/\1/p' README.md | paste -sd ,)
          echo "WEBSITE_URL=$LINKS" >> $GITHUB_ENV

      - name: Run Broken Links Checker
        run: |
          # Split the list of links into an array separated by commas
          read -ra LINKS <<< $WEBSITE_URL
          BROKEN_LINKS=()
          
          # Scan the links and verify if they are reachable
          for link in "${LINKS[@]}"; do
              if ! curl -IsSk "$link" > /dev/null; then
                BROKEN_LINKS+=("$link")
              fi
          done
          
          if [ ${#BROKEN_LINKS[@]} -gt 0 ]; then
           echo "Broken links found: ${BROKEN_LINKS[@]}" >&2
           echo "Broken links found, failing the workflow" >&2
           exit 1
          else
           echo "No broken links found"
          fi
         # Creare una stringa separata da virgole dei link problematici
         BROKEN_LINKS_STRING=$(IFS=','; echo "${BROKEN_LINKS[*]}")
         # Passare BROKEN_LINKS_STRING come variabile d'ambiente
         echo "BROKEN_LINKS=$BROKEN_LINKS_STRING" >> $GITHUB_ENV
      - uses: actions/checkout@v3
        if: failure()

      - uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          filename: ${{ env.ISSUE_TEMPLATE }}
        if: failure()